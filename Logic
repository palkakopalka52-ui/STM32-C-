#include "main.h"

ADC_HandleTypeDef hadc1;

#define LED_PORT        GPIOB
#define LED_PINS_ALL   (GPIO_PIN_0 | GPIO_PIN_1 | GPIO_PIN_2 | GPIO_PIN_3 | \
                        GPIO_PIN_4 | GPIO_PIN_5 | GPIO_PIN_6 | GPIO_PIN_7)

#define STATUS_PORT     GPIOC
#define STATUS_PIN      GPIO_PIN_13

#define VREF        3.3f
#define ADC_MAX     4095.0f

#define R_TOP       51000.0f
#define R_BOTTOM    33000.0f

#define U_BAT_MIN   7.0f
#define U_BAT_MAX   8.4f

static void MX_GPIO_Init(void)
{
    __HAL_RCC_GPIOA_CLK_ENABLE();
    __HAL_RCC_GPIOB_CLK_ENABLE();
    __HAL_RCC_GPIOC_CLK_ENABLE();

    GPIO_InitTypeDef GPIO_InitStruct = {0};

    GPIO_InitStruct.Pin   = LED_PINS_ALL;
    GPIO_InitStruct.Mode  = GPIO_MODE_OUTPUT_PP;
    GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
    HAL_GPIO_Init(LED_PORT, &GPIO_InitStruct);

    GPIO_InitStruct.Pin   = STATUS_PIN;
    GPIO_InitStruct.Mode  = GPIO_MODE_OUTPUT_PP;
    GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
    HAL_GPIO_Init(STATUS_PORT, &GPIO_InitStruct);

    GPIO_InitStruct.Pin  = GPIO_PIN_0;
    GPIO_InitStruct.Mode = GPIO_MODE_ANALOG;
    HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

    HAL_GPIO_WritePin(LED_PORT, LED_PINS_ALL, GPIO_PIN_SET);
}

static void MX_ADC1_Init(void)
{
    __HAL_RCC_ADC1_CLK_ENABLE();

    hadc1.Instance = ADC1;
    hadc1.Init.ScanConvMode        = ADC_SCAN_DISABLE;
    hadc1.Init.ContinuousConvMode  = DISABLE;
    hadc1.Init.DiscontinuousConvMode = DISABLE;
    hadc1.Init.ExternalTrigConv    = ADC_SOFTWARE_START;
    hadc1.Init.DataAlign           = ADC_DATAALIGN_RIGHT;
    hadc1.Init.NbrOfConversion     = 1;
    HAL_ADC_Init(&hadc1);

    ADC_ChannelConfTypeDef sConfig = {0};
    sConfig.Channel      = ADC_CHANNEL_0;
    sConfig.Rank         = ADC_REGULAR_RANK_1;
    sConfig.SamplingTime = ADC_SAMPLETIME_55CYCLES_5;
    HAL_ADC_ConfigChannel(&hadc1, &sConfig);

    HAL_ADCEx_Calibration_Start(&hadc1);
}
static float adc_to_bat_voltage(uint16_t adc)
{
    float u_adc = (adc / ADC_MAX) * VREF;
    float k_div = (R_TOP + R_BOTTOM) / R_BOTTOM;
    return u_adc * k_div;
}

static uint8_t bat_voltage_to_level(float u_bat)
{
    if (u_bat <= U_BAT_MIN)
        return 0;
    if (u_bat >= U_BAT_MAX)
        return 8;

    float step = (U_BAT_MAX - U_BAT_MIN) / 8.0f;
    uint8_t level = 1u + (uint8_t)((u_bat - U_BAT_MIN) / step);
    if (level > 8) level = 8;
    return level;
}

static void leds_set_level(uint8_t level)
{
    for (uint8_t i = 0; i < 8; i++)
    {
        GPIO_PinState st = (i < level) ? GPIO_PIN_RESET : GPIO_PIN_SET;
        HAL_GPIO_WritePin(LED_PORT, (uint16_t)(1u << i), st);
    }
}
int main(void)
{
    HAL_Init();
    SystemClock_Config();

    MX_GPIO_Init();
    MX_ADC1_Init();

    uint32_t status_tick = HAL_GetTick();

    while (1)
    {
        HAL_ADC_Start(&hadc1);
        HAL_ADC_PollForConversion(&hadc1, HAL_MAX_DELAY);
        uint16_t adc_raw = (uint16_t)HAL_ADC_GetValue(&hadc1);
        HAL_ADC_Stop(&hadc1);

        float u_bat = adc_to_bat_voltage(adc_raw);

        uint8_t level = bat_voltage_to_level(u_bat);
        leds_set_level(level);

        uint32_t now = HAL_GetTick();
        if (now - status_tick >= 500)
        {
            status_tick = now;
            HAL_GPIO_TogglePin(STATUS_PORT, STATUS_PIN);
        }

        HAL_Delay(100);
    }
}
